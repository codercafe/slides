<!doctype html>
<html>

<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">

  <title>Testing</title>

  <link rel="stylesheet" href="../reveal.js/css/reveal.css">
  <link rel="stylesheet" href="../reveal.js/css/theme/simple.css">

  <!-- Theme used for syntax highlighting of code -->
  <link rel="stylesheet" href="../reveal.js/lib/css/zenburn.css">

  <!-- Printing and PDF exports -->
  <script>
    var link = document.createElement('link');
    link.rel = 'stylesheet';
    link.type = 'text/css';
    link.href = window.location.search.match(/print-pdf/gi) ? '../reveal.js/css/print/pdf.css' : '../reveal.js/css/print/paper.css';
    document.getElementsByTagName('head')[0].appendChild(link);
  </script>
</head>

<body>
  <div class="reveal">
    <div class="slides">
      <section>
        <h1>Code Academy</h1>
        <h3>Session #1: Testing (Java)</h3>
        <p>
          <small>Created by
            <a href="https://github.com/larsp">Lars</a>,
            <a href="https://github.com/frankwis">Frank</a> &amp;
            <a href="https://github.com/utobi">Tobi</a></small>
        </p>
      </section>

      <section>
        <section data-background="img/testing.jpg">
          <h1>Testing?</h1>
          <small><a href="https://flic.kr/p/8jZ45h">Role Reversal</a> by Kenny Louie - Some rights reserved <a href="https://creativecommons.org/licenses/by/2.0/">CC BY 2.0</a></small>
          <aside class="notes">
            tbd
          </aside>
        </section>
        <section>
          <p><q class="fragment">"I don't know how to write tests."&nbsp;</q></p>
          <p><q class="fragment">"I don't have enough time to write tests."&nbsp;</q></p>
          <p><q class="fragment">"Testing is not my job."&nbsp;</q></p>
          <p><q class="fragment">"Writing tests is too hard."&nbsp;</q></p>
          <p><q class="fragment">"My code is too simple for tests."&nbsp;</q></p>
          <p><q class="fragment">...</q></p>
          <h2 class="fragment">all &#128169;</h2>
        </section>
        <section>
          <h2>Motivation</h2>
          <p>
            <ul>
              <li class="fragment">Does it work?</li>
              <li class="fragment">Is the Bug fixed?</li>
              <li class="fragment">Documentation</li>
              <li class="fragment">Enable change</li>
              <li class="fragment">Constrain Features</li>
              <li class="fragment">Improve Design</li>
              <li class="fragment">Faster Development</li>
            </ul>
          </p>
          <div class="fragment">&rarr; Fundamental Discipline</div>
          <aside class="notes">
            Reduce Fear
            Reduce Bugs in New Features<br/>
            Reduce Bugs in Existing Features<br/>
            Are Good Documentation<br/>
            Reduce the Cost of Change<br/>
            Allow Refactoring<br/>
            Improve Design<br/>
            Constrain Features<br/>
            Defend Against Other Programmers<br/>
            Forces You to Slow Down and Think<br/>
            Makes Development Faster<br/>
          </aside>
        </section>

        <section>
          <h2>Testing!</h2>
          <ul>
            <li class="fragment">Unit Testing</li>
            <li class="fragment">Integration Testing</li>
            <li class="fragment">Black box / Acceptance / Functional Testing</li>
            <li class="fragment">Performance Testing</li>
            <li class="fragment">...</li>
          </ul>
        </section>

        <section>
          <h2 class="fragment">What are your test requirements?</h2>
          <aside class="notes">
            More important than test tools, apis, frameworks are your test requirements.
          </aside>
        </section>
      </section>

      <section>
        <section>
          <h1>Unit Testing</h1>

          <aside class="notes">
          </aside>
        </section>

        <section>
          <h2>Class under test</h2>
          <pre class="fragment"><code data-trim class="java">
public class NumberCalculator {
    public String add(int x, int y) {...};
    public String subtract(int minuend, int sutrahend) {...};
    public String multiply(int x, int y) {...};
    public String divide(int divident, int divisor) {...};
    public List&lt;String&gt; primeFactorization(int number) {...};
}
          </code></pre>
          <pre class="fragment"><code data-trim class="java">
calculator.divide(12, 3)          // returns "four"
calculator.divide(-10, 4)         // returns "minus two point five"
calculator.primeFactorization(35) // returns ["five", "seven"]
          </code></pre>
          <aside class="notes">
            tbd
          </aside>
        </section>
        <section>
          <h2>JUnit (4)</h2>
          <pre class="fragment"><code data-trim class="java">
@Test
public void add() {
    NumberCalculator calculator = new NumberCalculator();
    assertEquals("fifteen", calculator.add(12, 3));
    assertEquals("fourteen", calculator.add(10, 4));
    assertEquals("minus seven", calculator.add(7, -14));
}
          </code></pre>
          <pre class="fragment"><code data-trim class="java">
@Test
public void divide() {
    NumberCalculator calculator = new NumberCalculator();
    assertEquals("four", calculator.divide(12, 3));
    assertEquals("two point five", calculator.divide(10, 4));
    assertEquals("minus two point five", calculator.divide(-10, 4));
}
          </code></pre>
          <pre class="fragment"><code data-trim class="java">
@Ignore("Order does matter")
@Test
public void primeFactorization() {
    NumberCalculator calculator = new NumberCalculator();
    assertEquals(calculator.primeFactorization(35), Arrays.asList("five", "seven"));
    assertEquals(calculator.primeFactorization(35), Arrays.asList("seven", "five"));
}
          </code></pre>
          <aside class="notes">
            JUnit4, 5 will be similar, not TestNG, but this is not important
          </aside>
        </section>

        <section>
          <h2>Hamcrest</h2>
          <aside class="notes">
            <ul>
              <li>Readability</li>
              <li>Extendable</li>
            </ul>
          </aside>
        </section>
        <!--  -->
        <section>
          <h3>Provided Hamcrest Matcher</h3>
          <pre class="fragment"><code data-trim class="java">
@Test
public void divideWithMatchers() {
    NumberCalculator calculator = new NumberCalculator();
    assertThat(calculator.divide(12, 3), is(equalTo("four")));
    assertThat(calculator.divide(10, 4), is(equalTo("two point five")));
}
          </code></pre>
          <pre class="fragment"><code data-trim class="java">
@Test
public void primeFactorization() {
    NumberCalculator calculator = new NumberCalculator();
    assertThat(calculator.primeFactorization(350), hasItems("two", "five", "seven"));
    // fyi: 350 = 2 * 5 * 5 * 7
}
          </code></pre>
        </section>

        <section>
          <h3>Custom Hamcrest Matcher</h3>
          <pre><code data-trim class="java">
@Test
public void primeFactorizationCustomMatcher() {
  NumberCalculator calculator = new NumberCalculator();
  assertThat(calculator.primeFactorization(350), hasAllItems("two", "five", "five", "seven"));
  assertThat(calculator.primeFactorization(350), not(hasAllItems("two", "five", "seven")));
  // fyi: 350 = 2 * 5 * 5 * 7
}
        </code></pre>
        </section>
        <section>
          <h3>Custom Hamcrest Matcher</h3>
          <small><pre><code data-trim class="java">
public final class CustomCollectionItemsMatcher extends TypeSafeMatcher&lt;Collection&lt;String&gt;&gt; {

    private final String[] items;

    private CustomCollectionItemsMatcher(String... items) {
        this.items = items;
    }

    public static Matcher&lt;Collection&lt;String&gt;&gt; hasAllItems(String... items) {
        return new CustomCollectionItemsMatcher(items);
    }

    @Override
    protected boolean matchesSafely(Collection&lt;String&gt; item) {
        if (items.length != item.size()) {
            return false;
        }

        Map&lt;String, Long&gt; counts = item.stream()
                .collect(groupingBy(element -> element, counting()));
        return !counts.keySet().stream()
                .anyMatch(value -> Collections.frequency(item, value) != counts.get(value));
    }

    @Override
    public void describeTo(Description description) {
        description.appendText("a collection containing ")
                .appendValue(items)
                .appendText(" in arbitrary order");
    }
}
        </code></pre></small>
        </section>

        <section>
          <h3>Matcher Implementations</h3>
          <ul>
            <li class="fragment"><code>BaseMatcher</code> implements <code>describeMismatch</code> and <code>toString</code></li>
            <li class="fragment"><code>CustomMatcher</code> extends <code>BaseMatcher</code> and implements <code>describeTo</code></li>
            <li class="fragment"><code>TypeSafeMatcher</code> extends <code>BaseMatcher</code> and implements type safety and not null</li>
            <li class="fragment"><code>CustomTypeSafeMatcher</code> extends <code>TypeSafeMatcher</code> and implements <code>describeTo</code></li>
            <li class="fragment"><code>TypeSafeDiagnosingMatcher</code> implements <code>BaseMatcher</code>, type safety and not null with diagnostics</li>
          </ul>
          </section>
        <section>
          <h2>Exception Testing</h2>
          <pre><code data-trim class="java">
@Test(expected = ArithmeticException.class)
public void divideByNull() {
    NumberCalculator calculator = new NumberCalculator();
    ... // some calls and asserts
    calculator.divide(12, 0);
}
          </code></pre>
          <pre class="fragment"><code data-trim class="java">
@Rule
public final ExpectedException expected = ExpectedException.none();

@Test
public void divideByNullTestRule() {
    NumberCalculator calculator = new NumberCalculator();
    expected.expect(ArithmeticException.class);
    expected.expectMessage("Cannot divide by null");
    calculator.divide(12, 0);
}
           </code></pre>
        </section>

        <section>
          <h2>Mocking with Mockito</h2>
          <aside class="notes">
            defactor standard in our team with the most active communit on GitHub (+3300 stargazers)
          </aside>
        </section>
        <section>
          <h3>Class under test</h3>
          <pre><code data-trim class="java">
public class CalculatorService {

    private NumberCalculator numberCalculator;
    private WordCalculator wordCalculator;

    public CalculatorService(WordCalculator wordCalculator) {
        this.numberCalculator = new NumberCalculator();
        this.wordCalculator = wordCalculator;
    }

    public String mixedAdd(int a, String b) {
        try {
            return numberCalculator.add(a, wordCalculator.parseInt(b));
        } catch (ParseException ex) {
            throw new CalculatorServiceException("Something went wrong", ex);
        }
    }
}
          </code></pre>
        </section>
        <section>
          Enable Annotations
          <pre><code data-trim class="java">
@RunWith(MockitoJUnitRunner.class)
public class CalculatorServiceTest {
...
}
          </code></pre>
          <pre class="fragment"><code data-trim class="java">
@Rule
public MockitoRule rule = MockitoJUnit.rule();
          </code></pre>
          <pre class="fragment"><code data-trim class="java">
@Before
public void initMocks() {
    MockitoAnnotations.initMocks(this);
}
          </code></pre>
        </section>
        <section>
          <p><code>@Mock</code></p>
          <pre class="fragment"><code data-trim class="java">
@Mock
private WordCalculator wordCalculator;
          </code></pre>
          <pre class="fragment"><code data-trim class="java">
@Test
public void testMixedAdd() throws Exception {
    when(wordCalculator.parseInt(anyString())).thenReturn(42);

    CalculatorService calculatorService = new CalculatorService(wordCalculator);
    String result = calculatorService.mixedAdd(42, "123");

    assertThat(result, is(equalTo("eighty-four")));
    verify(wordCalculator, never()).add(anyString(), anyString());
}
          </code></pre>
          <div class="fragment"><p>alternative:</p>
            <pre><code data-trim class="java">
// YOU need to take care of the life cycle!!!
WordCalculator wordCalculator = mock(WordCalculator.class);
            </code></pre>
          </div>
          <aside class="notes">
            when using mock() lifecycle handling (resetting) taken care of.
          </aside>
        </section>
        <section>
          <code>@Spy</code>
          <pre class="fragment"><code data-trim class="java">
@Spy
private WordCalculator wordCalculatorSpy = new WordCalculator();
          </code></pre>
          <pre class="fragment"><code data-trim class="java">
@Test
public void testMixedAddWithSpy() throws Exception {
    CalculatorService calculatorService = new CalculatorService(wordCalculatorSpy);
    String result = calculatorService.mixedAdd(42, "42");
    assertThat(result, is(equalTo("eighty-four")));

    verify(wordCalculatorSpy, times(1)).parseInt(anyString());
    verify(wordCalculatorSpy, never()).add(anyString(), anyString());
}
          </code></pre>
          <div class="fragment"><p>alternative:</p>
            <pre><code data-trim class="java">
WordCalculator wordCalculatorSpy = spy(new WordCalculator());
WordCalculator wordCalculatorSpy = spy(WordCalculator.class);
            </code></pre>
          </div>
          <q class="fragment">Overusing spies hints at code design smells.</q>
        </section>
        <section>
          <code>@Captor</code>
          <pre class="fragment"><code data-trim class="java">
@Captor
ArgumentCaptor&lt;Integer&gt; captor;
          </code></pre>
          <pre class="fragment"><code data-trim class="java">
@Test
public void testMixedAddWithWhiteboxAndCaptor() throws Exception {
    CalculatorService calculatorService = new CalculatorService(wordCalculator);
    Whitebox.setInternalState(calculatorService, "numberCalculator", numberCalculator);

    when(wordCalculator.parseInt(anyString())).thenReturn(42);
    when(numberCalculator.add(captor.capture(), captor.capture())).thenReturn("123");

    calculatorService.mixedAdd(123, "123");

    assertThat(captor.getAllValues(), contains(123, 42));
    verify(wordCalculator, never()).add(anyString(), anyString());
}
          </code></pre>
          <div class="fragment"><p>alternative:</p>
            <pre><code data-trim class="java">
ArgumentCaptor&lt;Integer&gt; captor = ArgumentCaptor.forClass(Integer.class);
            </code></pre>
          </div>
        </section>
        <section>
          <code><del>@InjectMocks</del></code>
          <p class="fragment">Make your dependencies visible</p>
        </section>
        <section>
          <h2>Remember<sup><small>1</small></sup></h2>
          <ul>
            <li class="fragment strike">Do not mock types you don’t own</li>
            <li>Don’t mock value objects</li>
            <li>Don’t mock everything</li>
            <li>Show love with your tests!</li>
            <li class="fragment">Sometimes mocking an API, Driver etc. makes sense, but don't mock e.g. <code>ArrayList</code></li>
          </ul>
          <p><small>[1] <a href="http://mockito.org/" target="_blank">mockito.org</a></small></p>
          <aside class="notes">
            Sometimes you have to mock an API, database driver, etc. But don't mock a ArrayList, just use it.
          </aside>
        </section>
        <section>
          <q>Using PowerMock hints at code design smells.</q>
          <aside class="notes">
            Word of caution
          </aside>
        </section>

        <section>
          <h2>Guava Testutils</h2>
          <small>Class under test:</small>
          <pre><code data-trim class="java">
public class StringPoint3D implements Serializable {

  public final String x, y, z;

  public StringPoint3D(String x, String y, String z) throws ParseException {...}

  public StringPoint3D(int x, int y, int z) {
    this.x = format(x);
    this.y = format(y);
    this.z = format(z);
  }

  @Override
  public boolean equals(Object o) {...}

  @Override
  public int hashCode() {...}

}
          </code></pre>
        </section>
        <section>
          <p><q>Always override <code>hashCode</code> when you override <code>equals</code></q></p>
        </section>
        <section>
          <h3>EqualsTester</h3>
          <pre class="fragment"><code data-trim class="java">
StringPoint3D point = new StringPoint3D(3, 2, 1);

// object against null returns false
assertFalse(point.equals(null));
// incompatible class returns false
assertFalse(point.equals(new WordCalculator()));
// different parameters result in inequality
assertFalse(point.equals(new StringPoint3D(1, 2, 3)));
// object against itself returns true
assertTrue(point.equals(point));
// same parameters result in equality
assertTrue(point.equals(new StringPoint3D(3, 2, 1)));
// hash code matches on equality
assertEquals(point.hashCode(), new StringPoint3D(3, 2, 1).hashCode());
          </code></pre>
          <pre class="fragment"><code data-trim class="java">
// What about the String constructor?
new StringPoint3D("three", "two", "one");
          </code></pre>
          <pre class="fragment"><code data-trim class="java">
new EqualsTester()
          .addEqualityGroup(new StringPoint3D(1, 2, 3),
                  new StringPoint3D("one", "two", "three"))
          .addEqualityGroup(new StringPoint3D(0, 0, 0),
                  StringPoint3D.ZERO)
          .testEquals();
          </code></pre>

          <aside class="notes">
            EqualsTester:
            <ul>
              <li>comparing each object against itself returns true</li>
              <li>comparing each object against null returns false</li>
              <li>comparing each object against an instance of an incompatible class returns false</li>
              <li>comparing each pair of objects within the same equality group returns true</li>
              <li>comparing each pair of objects from different equality groups returns false</li>
              <li>the hash codes of any two equal objects are equal</li>
            </ul>
          </aside>
        </section>
        <section>
          <h3>NPEs &amp; Serializables</h3>
          <pre class="fragment"><code data-trim class="java">
@Test
public void nullPointerException() {
    new NullPointerTester()
          .setDefault(String.class, "null")
          .testAllPublicConstructors(StringPoint3D.class);
}
          </code></pre>
          <pre class="fragment"><code data-trim class="java">
@Test
public void serializable() throws ParseException {
    SerializableTester.reserializeAndAssert(new StringPoint3D("one", "two", "three"));
}
          </code></pre>
          <aside class="notes">
            <ul>
              <li>NullPointerTester
                <ul>
                  <li>A test utility that verifies that your methods/constructors throw <tt>NPE</tt>s or <tt>UnsupportedOperationException</tt> whenever null is passed to a parameter that isn't annotated with <tt>Nullable</tt>.</li>
                  <li><tt>setDefault</tt> provides a custom non-null default value for the parameter type.</li>
                </ul>
              </li>
              <li>SerializableTester
                <ul>
                  <li>Tests serialization and deserialization of an object, optionally asserting that the resulting object is equal to the original.</li>
                  <li><tt>reserializeAndAssert</tt> calls EqualsTester</li>
                  <li><tt>reserialize</tt> just serializes and reserializes via ByteStream</li>
                </ul>
              </li>
            </ul>
          </aside>
        </section>

        <section>
          <h2>Test Coverage</h2>
          <p class="fragment">
            <img width="65%" src="img/code_coverage_screenshot.png"/>
          </p>
        </section>
        <section>
          <h3>Coverage Types</h3>
          <p>
            <ul>
              <li class="fragment">Function coverage</li>
              <li class="fragment">Line/Statement coverage</li>
              <li class="fragment">Branch coverage</li>
              <li class="fragment">Condition/Predicate coverage</li>
              <li class="fragment">...</li>
            </ul>
          </p>
          <aside class="notes">
            <ul>
              <li><b>Function</b> All functions/methods been called?</li>
              <li><b>Statement</b> All statements executed? <code>(Number of statements exercised/Total number of statements)*100</code></li>
              <li><b>Path/Branch</b> All branches of each control structure executed?</li>
              <li><b>Condition/Predicate</b> Has each predicate been evaluated both to true and false?</li>
            </ul>
            <code>
if ((a == 1) | (b == 3)) ...
// branch coverage with
(1) a = 1, b = 2
(2) a = 2, b = 2
// predicate coverage with
(1) a = 1, b = 2
(2) a = 0, b = 3
            </code>
          </aside>
        </section>

        <section>
          <h2>Async Testing</h2>
          <small>Class under test:<br />
            <pre><code data-trim class="java">
public class LazyFibonacciCalculator {

    private final RuleBasedNumberFormat spelloutFormatter = new RuleBasedNumberFormat(ENGLISH, SPELLOUT);
    private static Logger logger = LoggerFactory.getLogger(LazyFibonacciCalculator.class);
    private AtomicReference&lt;String&gt; value = new AtomicReference&lt;&gt;();

    public void calculate(int number) {
        new Thread(() -> {
            if (number == 1 || number == 2) {
                value.set(spelloutFormatter.format(1));
            }
            int lastFibonacci = 1, currentFibonacci = 1, result = 1;
            for (int i = 3; i <= number; i++) {
                result = lastFibonacci + currentFibonacci;
                lastFibonacci = currentFibonacci;
                currentFibonacci = result;

                // let's be lazy
                try {
                    Thread.sleep(50 + random.nextInt(1000));
                } catch (InterruptedException ex) {
                    logger.warn("Couldn't be lazy.", ex);
                }

            }
            value.set(spelloutFormatter.format(result));
        }).start();
    }

    public String getResult() {
        return value.get();
    }
}
            </code></pre>
          </small>
        </section>

        <section>
          <h2>Awaitility</h2>
          <pre class="fragment"><code data-trim class="java">
@Ignore("Bad pattern: Sleep duration unforeseeable.")
@Test
public void calculateWithThreadSleep() throws InterruptedException {
    LazyFibonacciCalculator calculator = new LazyFibonacciCalculator();
    calculator.calculate(20);
    assertNull(calculator.getResult());
    Thread.sleep(15000);
    assertThat(calculator.getResult(), is(equalTo("six thousand seven hundred sixty-five")));
}
          </code></pre>
          <pre class="fragment"><code data-trim class="java">
@Test
public void calculateWithAwaitility() {
    LazyFibonacciCalculator calculator = new LazyFibonacciCalculator();
    calculator.calculate(20);
    // callable
    await().until(calculator::getResult,
            is(equalTo("six thousand seven hundred sixty-five")));
    // proxy
    await().untilCall(to(calculator).getResult(),
            is(equalTo("six thousand seven hundred sixty-five")));
}
          </code></pre>
        </section>

        <section data-background="img/tea_time.jpg">
          <h1>Tea Time</h1>
          <small><a href="https://flic.kr/p/irWvoG">Tea Time</a> by Prayitno Hadinata - Some rights reserved <a href="https://creativecommons.org/licenses/by/2.0/">CC BY 2.0</a></small>
          <aside class="notes">
            Short break before hands-on practice
          </aside>
        </section>

        <section>
          <h2><code>// TODO</code></h2>
          <p>
            <ul>
              <li class="fragment">Checkout the <a href="http://github.com/codercafe/samples">samples</a></li>
              <li class="fragment">Analyze test coverage</li>
              <li class="fragment">Bring it to 100% &#128526;</li>
            </ul>
          </p>
        </section>

        <section>
          <q cite="http://martinfowler.com/articles/continuousIntegration.html">
            Imperfect tests, run frequently, are much better than perfect tests that are never written at all.<br/> --Martin Fowler
          </q>
          <aside class="notes">
            Motivational slide for presenting results of hands-on session.
          </aside>
        </section>

        <section>
          <h2>JUnit Revisited</h2>
          <ul>
            <li>Test Flow</li>
            <li>Statement</li>
            <li>TestRule</li>
          </ul>
        </section>

        <section>
          <h3>Test Flow</h3>
          <pre><code data-trim class="java">
// simplified view on JUnit's nesting model

@ClassRule (
  @BeforeClass
  @Rule (
    @Before
    @Test
    @After
  )
  @AfterClass
)
          </code></pre>
        </section>
        <section>
          <h3>Statements</h3>
          <pre><code data-trim class="java">
//A statement represents an action that has to be performed at runtime to run a test
public abstract class Statement {
    public abstract void evaluate() throws Throwable;
}
          </code></pre>
          <pre class="fragment"><code data-trim class="java">
//For each @Test annotated method an InvokeMethod will be instantiated
public class InvokeMethod extends Statement {

    public InvokeMethod(FrameworkMethod testMethod, Object target) {...}

    @Override
    public void evaluate() throws Throwable {
        testMethod.invokeExplosively(target);
    }
}
          </code></pre>
          <pre class="fragment"><code data-trim class="java">
//Each @AfterClass and @After annotated method will be represented via some RunAfters instance
public class RunAfters extends Statement {

    public RunAfters(Statement next, List&lt;FrameworkMethod&gt; afters, Object target) {...}

    @Override
    public void evaluate() throws Throwable {
        next.evaluate();
        for (FrameworkMethod each : afters) {
            each.invokeExplosively(target);
        }
    }
}
          </code></pre>
          <aside class="notes">
            <ul>
              <li>A <code>Statement</code> represents an action that has to be performed at runtime to run a test.</li>
              <li>Statements maybe chained (see RunAfters, RunBefores, FailOnTimeout, ExpectException)</li>
              <li>@Test(timeout = 1000)</li>
              <li>Not chained: InvokeMethod, Fail</li>
            </ul>
          </aside>
        </section>

        <section>
          <h3>TestRule</h3>
          <pre><code data-trim class="java">
// TestRules may intercept a Statement's evaluation
public interface TestRule {
    Statement apply(Statement base, Description description);
}
          </code></pre>
          <pre class="fragment"><code data-trim class="java">
// Paradigmatic implementation of ExternalResource
public abstract class ExternalResource implements TestRule {

    public Statement apply(Statement base, Description description) {
        return new Statement() {
            @Override
            public void evaluate() throws Throwable {
                before();
                try {
                    base.evaluate();
                } finally {
                    after();
                }
            }
        };
    }

    protected void before() throws Throwable {};
    protected void after() {};
}
          </code></pre>
        </section>

        <section>
          <h3>Extending TestRule</h3>
          <pre><code data-trim class="java">
public class ServerResource extends ExternalResource {

    public ServerResource(Server server) {
        this.server = server;
    }

    @Override
    protected void before() throws Throwable {
        server.connect();
    }

    @Override
    protected void after() {
        server.disconnect();
    }
}
          </code></pre>
        </section>
        <section>
          <h3>Test Rules</h3>
          <small>
            <ul>
              <li><code>DisableOnDebug</code> allows labeling certain rules to be disabled when debugging.</li>
              <li><code>ExpectedException</code> allows verifying that code throws a specific exception.</li>
              <li><code>ExternalResource</code> is a base class for Rules that set up an external resource before a test (a file, socket, server, database connection, etc.), and guarantee to tear it down afterward.</li>
              <li><code>TemporaryFolder</code> allows creation of files and folders that should be deleted when the test method finishes (whether it passes or fails). Extends <code>ExternalResource</code></li>
              <li><code>RuleChain</code> allows ordering of TestRules.</li>
              <li><code>RunRules</code> runs a collection of rules on a statement.</li>
              <li><code>Stopwatch</code> notifies one of its own protected methods of the time spent by a test.</li>
              <li><code>TestName</code> makes the current test name available inside test methods.</li>
              <li><code>TestWatcher</code> is a base class for Rules that take note of the testing action, without modifying it.</li>
              <li><code>Timeout</code> applies the same timeout to all test methods in a class.</li>
              <li><code>Verifier</code> is a base class for Rules like ErrorCollector, which can turn otherwise passing test methods into failing tests if a verification check is failed.</li>
              <li><code>ErrorCollector</code> allows execution of a test to continue after the first problem is found (for example, to collect <b>all</b> the incorrect rows in a table, and report them all at once).</li>
            </ul>
            <br /><br />
            Source: <a href="http://junit.org/junit4/javadoc/latest/org/junit/rules/package-summary.html">JavaDocs</a>
          </small>
        </section>
      </section>

      <!-- ***** Integration Testing ***** -->
      <section>
        <section>
          <h1>Integration Testing</h1>
        </section>

        <section>
          <h2>JAX-RS (Jersey)</h2>
        </section>
        <section>
          <h3>Service under Test</h3>
          <pre><code data-trim class="java">
@Path("/hello")
@Produces(APPLICATION_JSON)
public class HelloWorld {

    @GET
    public Hello hello() {
        return new Hello("World");
    }
}
          </code></pre>
        </section>

        <section>
          <h3><code>JerseyTest</code></h3>
          <pre><code data-trim class="java">
public class HelloWorldTest extends JerseyTest {
...
    @Test
    public void testHelloWorldIndent() throws Exception {
        String result = target("hello").request().get(String.class);
        logger.info("Response: {}", result);
    }

    @Test
    public void testHelloWorld() throws Exception {
        Hello hello = target("hello").request().get(Hello.class);
        assertThat(hello.hello, is(equalTo("World")));
    }
}
          </code></pre>
        </section>
        <section>
          <h3>Configuration</h3>
          <pre><code data-trim class="java">
@Override
protected Application configure() {
    return new ResourceConfig() {
        {
            register(DefaultObjectMapper.class);
            register(new HelloWorld());
        }
    };
}
          </code></pre>
          <p>Also works for JAX-RS components: e.g. <code>ExceptionMapper</code>
        </section>

        <section>
          <h3>Beware the <code>ObjectMapper</code>!!!!</h3>
          <pre class="fragment"><code data-trim class="java">
  @Override
  protected void configureClient(ClientConfig config) {
      JacksonJsonProvider jsonProvider = new JacksonJsonProvider();
      jsonProvider.setMapper(new ObjectMapperBuilder().build());
      config.register(jsonProvider);
  }
          </code></pre>
          <p class="fragment">Always register you custom ObjectMapper</p>
          <pre class="fragment"><code data-trim class="java">
@Provider
@Priority(Priorities.ENTITY_CODER - 1)
@Consumes(APPLICATION_JSON)
@Produces(APPLICATION_JSON)
public class DefaultObjectMapper implements ContextResolver&lt;ObjectMapper&gt; {

    private final ObjectMapper defaultObjectMapper = new ObjectMapperBuilder().build();

    @Override
    public ObjectMapper getContext(Class&lt;?&gt; type) {
        return defaultObjectMapper;
    }
}
          </code></pre>
        </section>

        <section>
          <h3>Beware the Classpath</h3>
          <pre><code data-trim class="java">
compile([
        "javax.ws.rs:javax.ws.rs-api:2.0.1",
        "org.glassfish.jersey.core:jersey-server:$jerseryVersion",
        "com.fasterxml.jackson.core:jackson-core:$jacksonVersion",
        "com.fasterxml.jackson.core:jackson-databind:$jacksonVersion",
        "com.fasterxml.jackson.core:jackson-annotations:$jacksonVersion"
])

testCompile([
        "org.slf4j:slf4j-simple:$slf4jVersion",
        "org.glassfish.jersey.test-framework.providers:jersey-test-framework-provider-jetty:$jerseryVersion",
        "org.glassfish.jersey.test-framework:jersey-test-framework-core:$jerseryVersion",
        "org.glassfish.jersey.media:jersey-media-json-jackson:$jerseryVersion"
])
          </code></pre>
        </section>

        <section>
          <h3>Tools:</h3>
          <ul>
            <li class="fragment">Cassandra Unit</li>
            <li class="fragment">DbUnit</li>
            <li class="fragment">Kafka/ZooKeeper Helper</li>
            <li class="fragment">Vagrant, Docker</li>
            <li class="fragment">...</li>
          </ul>
        </section>
      </section>

      <!-- ***** Groovy ***** -->
      <section>
        <section>
          <h1>Groovy</h1>
          Concise, domain agnostic and better readable tests.
        </section>
        <section>
          <h2>Java classes under test</h2>
          <pre><code data-trim class="java">
public class SoftwareEngineer {

public SoftwareEngineer(String name, long phone) {
this(name, phone, null);
}

public SoftwareEngineer(String name, long phone, URL gitHub) {
this.name = name;
this.phone = phone;
this.gitHub = gitHub;
}

@Override
public boolean equals(Object o) {...}

@Override
public int hashCode() {...}
}
          </code></pre>
          <pre><code data-trim class="java">
public interface YellowPages {
    SoftwareEngineer getEngineer(UUID id);
}
          </code></pre>
        </section>

        <section>
          <h2>Coercion &amp; Mocking</h2>
          <pre><code data-trim class="groovy">
@Test
public void typeCoercion() {
// SoftwareEngineer via implicit and URL via explicit Coercion
SoftwareEngineer engineer = ["Frank", 1234567890,
                             ["https://github.com/frankwis"] as URL]

assertThat engineer,
    is(equalTo(new SoftwareEngineer("Frank", 1234567890,
            new URL("https://github.com/frankwis"))))
}
          </code></pre>
          <pre class="fragment"><code data-trim class="groovy">
@Test
public void mocking() {
def engineer = ["John Doe", 1234] as SoftwareEngineer

def closureCoercedService = { UUID id -> engineer } as YellowPages
assertThat closureCoercedService.getEngineer(randomUUID()),
    is(equalTo(new SoftwareEngineer("John Doe", 1234)))

def mapCoercedService = [getEngineer: { UUID id -> engineer }] as YellowPages
assertThat mapCoercedService.getEngineer(randomUUID()),
    is(equalTo(new SoftwareEngineer("John Doe", 1234)))
}
          </code></pre>
        </section>

        <section>
          <h2>Domain Independence</h2>
          <pre><code data-trim class="groovy">
@EqualsAndHashCode
class Engineers {
    SoftwareEngineer[] participants;
    SoftwareEngineer[] tutors;
}
          </code></pre>
          <pre class="fragment"><code data-trim class="groovy">
@Test
public void groovyBean() {
    // explicit
    def engineers1 = [participants: [["John Doe", 1234], ["Jane Doe", 4321]],
                      tutors      : [["Frank", 555666777], ["Lars", 111222333]]] as Engineers

    // implicit
    Engineers engineers2 = [participants: [["John Doe", 1234], ["Jane Doe", 4321]],
                            tutors      : [["Frank", 555666777], ["Lars", 111222333]]]
    assertThat engineers1, is(equalTo(engineers2))
}
          </code></pre>
        </section>

      </section>

      <!-- ***** Blackbox Testing ***** -->
      <section>
        <section>
          <h1>Blackbox Testing</h1>
        </section>
        <section>
          <h2>Service under test</h2>
          <small>
            <table>
              <tr>
                <td>HTTP Method</td>
                <td>Return Type</td>
                <td>Resource</td>
                <td>Functionality</td>
              </tr>
              <tr>
                <td>POST</td>
                <td>UUID</td>
                <td>/v1/counter</td>
                <td>Creates a new counter and returns its ID</td>
              </tr>
              <tr>
                <td>GET</td>
                <td>Collection&lt;UUID&gt;</td>
                <td>/v1/counters</td>
                <td>Lists all available counters</td>
              </tr>
              <tr>
                <td>GET</td>
                <td>Long</td>
                <td>/v1/counter/{id}</td>
                <td>Returns actual counter value</td>
              </tr>
              <tr>
                <td>PATCH</td>
                <td>Void</td>
                <td>/v1/counter/{id}</td>
                <td>Adds given value to specified counter</td>
              </tr>
              <tr>
                <td>GET</td>
                <td>String</td>
                <td>/v1/ping</td>
                <td>Returns "pong" when resource available</td>
              </tr>
            </table>
          </small>
        </section>

        <section>
          <h2>RestAssured</h2>
          <pre class="fragment"><code data-trim class="groovy">
@Test
public void postCounter() {
    UUID id = RestAssured.expect().statusCode(201)
                  .when().post(host + "/v1/counter")
                  .thenReturn().body().as(UUID.class)

    assertThat(id, is(notNullValue()))

    // await until counter is available and equals 0
    await().until({
        RestAssured
            .expect().statusCode(200)
            .when().get(host + "/v1/counter/" + id)
            .andReturn().as(Integer.class) == 0
    })
}
          </code></pre>
        </section>

        <section>
          <h2>Traits</h2>
          <pre><code data-trim class="groovy">
trait AwaitCounter {

    def await = { baseUrl, id ->
        def response
        await().until({
            response = RestAssured
                    .expect()
                    .statusCode(200)
                    .when()
                    .get(baseUrl + Constants.Service.COUNTER_PATH + "/" + id)
                    .andReturn()
        })
        response
    }
}
          </code></pre>
          <pre class="fragment"><code data-trim class="groovy">
class PostCounterTest extends BaseTest implements AwaitCounter {
    @Test
    public void postCounter() {
      UUID id = RestAssured.expect().statusCode(201)
                    .when().post(host + "/v1/counter")
                    .thenReturn().body().as(UUID.class);

      def response = await(host + "/v1/counter", id)
      int counter = response.body().as(Integer.class)
      assertThat(counter, is(equalTo(0)))
    }
}
          </code></pre>
        </section>
        <section>
          <h2>TestRule</h2>
          <pre><code data-trim class="java">
public class PingCheck extends ExternalResource {

    public PingCheck(Configuration configuration) {
        this.configuration = configuration;
    }

    @Override
    protected void before() throws Throwable {
        for (URI baseUrl : configuration.servers) {
            await().until(() -&gt;
                    RestAssured.when().get(baseUrl.resolve("/ping"))
                            .then().assertThat()
                            .statusCode(200).and().body(is(equalTo("pong")))
            );
        }
    }

    @Override
    protected void after() { /** nothing to do right now */ }
}
          </code></pre>
        </section>

        <section>
          <h3>Specification Frameworks</h3>
          <pre class="fragment"><code data-trim class="groovy">
class SpockSpecification extends Specification {

    def "Spock specification using Hamcrest matcher"() {
        given:
          final someMap = [name: 'John Doe']

        then:
          expect someMap, hasKey('name')
    }

}
          </code></pre>
          <pre class="fragment"><code data-trim class="groovy">
class SimpleTest : Spek({
  describe("a calculator") {
      val calculator = SampleCalculator()

      it("should return the result of adding the first number to the second number") {
          val sum = calculator.sum(2, 4)
          assertEquals(6, sum)
      }

      it("should return the result of subtracting the second number from the first number") {
          val subtract = calculator.subtract(4, 2)
          assertEquals(2, subtract)
      }
  }
})
          </code></pre>
        </section>
        <section>
          <h3>Spock: <code>given</code></h3>
          <pre class="fragment"><code data-trim class="groovy">
given: "A counter has been create and its UUID is known"
    def uuid = RestAssured
     .expect()
        .statusCode(201)
     .when()
        .post(baseUrl + COUNTER_PATH)
     .andReturn()
        .as(UUID.class)
          </code></pre>
          <pre class="fragment"><code data-trim class="groovy">
and: "A Patch object exists"
    def patchTo = [
                      "op"   : "add",
                      "path" : "path",
                      "value": "42"
                  ]
          </code></pre>
        </section>
        <section>
          <h3>Spock: <code>when/then</code></h3>
          <pre><code data-trim class="groovy">
when: "The counter is being patched"
    def response = RestAssured
        .given()
            .contentType(Constants.Service.ACCEPT_JSON_HEADER)
            .body(patchTo)
        .patch(baseUrl + COUNTER_PATH + "/" + uuid)
          </code></pre>
          <pre class="fragment"><code data-trim class="groovy">
then: "The Patch request has status code 204"
    assertThat(response.statusCode, is(204))

and: "The counter has been updated by 42"
    RestAssured.given()
        .when()
            .get(baseUrl + COUNTER_PATH + "/" + uuid)
        .then()
            .assertThat().body(equalTo("42"))
          </code></pre>
        </section>
      </section>


      <!-- ***** Performance Testing ***** -->
      <section>
        <section>
          <h1>Performance Testing</h1>
          <p>
            tbd
          </p>
        </section>

        <section>
          <h2>Gatling</h2>
          <p>
            tbd
          </p>
        </section>
      </section>

      <!-- ***** Summary ***** -->
      <section>
        <section>
          <h1>Summary</h1>
          <p>
            tbd
          </p>
        </section>

        <section>
          <h2>TBD</h2>
          <p>
            tbd
          </p>
        </section>
      </section>
    </div>
  </div>

  <script src="../reveal.js/lib/js/head.min.js"></script>
  <script src="../reveal.js/js/reveal.js"></script>

  <script>
    // More info https://github.com/hakimel/reveal.js#configuration
    Reveal.initialize({
      controls: true,
      progress: true,
      history: true,
      center: true,
      slideNumber: 'c/t',
      transition: 'slide', // none/fade/slide/convex/concave/zoom
      /*width: 1024,
      height: 768,
      margin: 0.1,
      minScale: 0.75,
      maxScale: 1.2,*/

      // More info https://github.com/hakimel/reveal.js#dependencies
      dependencies: [{
        src: '../reveal.js/plugin/markdown/marked.js'
      }, {
        src: '../reveal.js/plugin/markdown/markdown.js'
      }, {
        src: '../reveal.js/plugin/notes/notes.js',
        async: true
      }, {
        src: '../reveal.js/plugin/highlight/highlight.js',
        async: true,
        callback: function() {
          hljs.initHighlightingOnLoad();
        }
      }]
    });
  </script>
</body>

</html>
